<!DOCTYPE html>
<html lang="en">
<head>
          <title>Vorsprung durch Informatik</title>
        <meta charset="utf-8" />



    <meta name="tags" contents="Python" />
    <meta name="tags" contents="GitHub" />
    <meta name="tags" contents="software" />
    <meta name="tags" contents="adapter" />
    <meta name="tags" contents="cache" />
    <meta name="tags" contents="Linux" />
    <meta name="tags" contents="Memcached" />
    <meta name="tags" contents="PyOWM" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../">Vorsprung durch Informatik <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="../../2013/12/how-to-use-memcached-with-pyowm.html" rel="bookmark"
         title="Permalink to How to use Memcached with PyOWM">How to use Memcached with PyOWM</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2013-12-13T01:00:00">
      13/dic/2013 01:00
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="../../author/csparpa.html">csparpa</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>This is just a little demonstration on how you can quickly change the basic cache provider provided by the <a href="https://github.com/csparpa/pyowm">PyOWM library</a>.<br />
For this purpose we'll use Memcached, which – simply put – is a key/value in-memory data store: this turns it into a perfect caching mechanism.</p>
<h3>Requirements</h3>
<p>This demo requires that you work on a Linux env, as Memcached originally is shipped for Unix-like systems via packet distribution systems (but can nevertheless be compiled from source).<br />
I'll use Ubuntu, with Memcached 1.4.6 and PyOWM 0.4.0.<br />
Let's dive into it.<br />
First we install Memcached and the relative Python bindings:  </p>
<div class="highlight"><pre><span class="nv">$&gt;</span> sudo apt-get install memcached python-memcache
</pre></div>


<p>Then we install PyOWM library and check the installation:  </p>
<div class="highlight"><pre>sudo pip install pyowm
</pre></div>


<p>And we check then that library has correctly been installed by running from the Python console:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pyowm</span>
</pre></div>


<p>(if you don't get any error, then PyOWM was installed correctly).  </p>
<p>Finally, let's start Memcached:</p>
<div class="highlight"><pre><span class="nv">$&gt;</span> memcached &amp;
</pre></div>


<h3>Write the adapter</h3>
<p>In order to "plug" Memcached support into PyOWM we are going to leverage the installed Python bindings by creating
an adapter class that can conform the SW interface that PyOWM expects into the Memcached API for getting/setting cache elements.<br />
Fortunately, the Memcached API is very close to the PyOWM expected interface (which is stated into the <code>pyowm.abstractions.owmcache.OWMCache</code> class), so we have chances
that our adapter will be simple enough.<br />
Let's name it <code>memcachedadapter.py</code>: you can put it anywhere, provided that this anywhere is "seen" by the Python intepreter: in example, you can put it into any folder
listed into the <code>PYTHONPATH</code> variable or you can place it directly into the PyOWM install folder.<br />
In my distro, Python packages are installed by <code>pip</code> into folder <code>/usr/local/lib/python2.6/dist-packages</code>, I'll put the file over there.  </p>
<p>Let's write the adapter:</p>
<div class="highlight"><pre><span class="nv">$&gt;</span> <span class="nb">cd</span> /usr/local/lib/python2.6/dist-packages/pyowm
<span class="nv">$&gt;</span> sudo vim memcachedadapter.py
</pre></div>


<p>The module will contain the <code>MemcachedAdapter</code> class:</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="k">class</span> <span class="nc">MemcachedAdapter</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Realizes the pyowm.abstractions.owmcache.OWMCache interface</span>
<span class="sd">  adapting a memcache.Client object</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">__ITEM_LIFETIME_MILLISECONDS</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">10</span> <span class="c"># Ten minutes</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span>
      <span class="n">port</span><span class="o">=</span><span class="s">&quot;11211&quot;</span><span class="p">,</span> <span class="n">item_lifetime</span><span class="o">=</span><span class="n">__ITEM_LIFETIME_MILLISECONDS</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">memcache</span> <span class="kn">import</span> <span class="n">Client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_memcached</span> <span class="o">=</span> <span class="n">Client</span><span class="p">([</span><span class="n">hostname</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">port</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_item_lifetime</span> <span class="o">=</span> <span class="n">item_lifetime</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_url</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memcached</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_url</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_url</span><span class="p">,</span> <span class="n">response_json</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_memcached</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">request_url</span><span class="p">,</span> <span class="n">response_json</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_item_lifetime</span><span class="p">)</span>
</pre></div>


<p>I wrote this adapter in 5 minutes, so please don't blame me for errors ;-) it can surely be improved.  </p>
<p>Now what is left to do is to tell the PyOWM library how to use the adapter: this is done via configuration. The library requires an <code>OWMCache</code>
concrete instance which is created into a configuration file and injected into the code.  </p>
<p>We have two options now:
1. create a new configuration file, instantiate the cache adapter in that and then use the configuration file as a parameter when instantiating the PyOM global object
2. patch the default configuraton file, commenting out the default cache object that is provided  </p>
<p>The first solution requires us to write a new configuration module. Say our module will be <code>pyowm.webapi25.mycustomconfig.py</code>: then you need
to copy/paste all of the config data from the default <code>pyowm.webapi25.configuration25.py</code> configuration module, and then patch the
line where the default cache object is provided:</p>
<div class="highlight"><pre><span class="c"># Cache provider to be used</span>
<span class="c"># cache = NullCache()  # default cache provided by PyOWM: comment out</span>
<span class="kn">from</span> <span class="nn">memcachedadapter</span> <span class="kn">import</span> <span class="n">MemcachedAdapter</span>  <span class="c"># instantiate our adapter</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">MemcachedAdapter</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s">&quot;11211&quot;</span><span class="p">)</span>
</pre></div>


<p>Then you need to instantiate the PyOWM object by explicitly setting the path to our custom configuration module:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pyowm</span> <span class="kn">import</span> <span class="n">OWM</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">owm</span> <span class="o">=</span> <span class="n">OWM</span><span class="p">(</span><span class="n">config_module</span><span class="o">=</span><span class="s">&#39;pyowm.webapi25.mycustomconfig&#39;</span><span class="p">)</span>
</pre></div>


<p>The second solution is more of a hack and requires us to open module <code>pyowm.webapi25.configuration25.py</code> and do the same make up as above.
Once done, you can finally create the main PyOWM object without specifying any custom configuration module:  </p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pyowm</span> <span class="kn">import</span> <span class="n">OWM</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">owm</span> <span class="o">=</span> <span class="n">OWM</span><span class="p">()</span>
</pre></div>


<h3>See it in action</h3>
<p>In the above examples, we are adapting a local Memcached instance listening on the default 11211 port, but you can change this configuration as needed.<br />
Now let's try it out:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">not_cached</span> <span class="o">=</span> <span class="n">owm</span><span class="o">.</span><span class="n">daily_forecast</span><span class="p">(</span><span class="s">&quot;London,uk&quot;</span><span class="p">)</span>  <span class="c"># This first call to the API is not cached, obviously</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">owm</span><span class="o">.</span><span class="n">daily_forecast</span><span class="p">(</span><span class="s">&quot;London,uk&quot;</span><span class="p">)</span>      <span class="c"># This second call is cached</span>
</pre></div>


<p>Time saving should be at a glance!</p>
<h3>More cache adapters for PyOWM</h3>
<p>In a similar way it is possible to write adapters for plugging other cache/storage providers (Redis, MongoDB, etc..) into the PyOWM library.  </p>
<p>This post stimulated me to write more adapters, you can find them <a href="https://github.com/csparpa/pyowm-cache-adapters">on my GitHub repo</a>.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>